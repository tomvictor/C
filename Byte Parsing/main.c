#include <stdio.h>
#include <stdlib.h>


typedef struct {
    uint32_t timestamp;
    int32_t values[16];
} sensor_data_t;


uint8_t SensorSlice1[] = {0x02, 0x63, 0x78, 0x9e, 0xe9, 0xbe, 0x8b, 0xfc, 0xff, 0xff, 0x96, 0xf7, 0xff, 0xff, 0x71,
                          0xf5, 0xff, 0xff, 0x7c, 0xf9, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x1a, 0x04, 0x00, 0x00,
                          0x7d, 0x02, 0x00, 0x00, 0x99, 0xff, 0xff, 0xff, 0x0b, 0xff, 0xff, 0xff, 0xd4, 0xff, 0xff,
                          0xff, 0xc8, 0xff, 0xff, 0xff, 0x6a, 0xff, 0xff, 0xff, 0x5b, 0xff, 0xff, 0xff, 0x3c, 0xff,
                          0xff, 0xff, 0x1d, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xff, 0xff};
uint8_t SensorSlice2[] = {0x02, 0x63, 0x3c, 0xdf, 0x00, 0x00, 0xfa, 0xff, 0xff, 0xff, 0xd8, 0xff, 0xff, 0xff, 0xbd,
                          0xff, 0xff, 0xff, 0xbc, 0xff, 0xff, 0xff, 0x92, 0xff, 0xff, 0xff, 0xa3, 0xff, 0xff, 0xff,
                          0x96, 0xff, 0xff, 0xff, 0xa1, 0xff, 0xff, 0xff, 0xb2, 0xff, 0xff, 0xff, 0x9a, 0xff, 0xff,
                          0xff, 0xb9, 0xff, 0xff, 0xff, 0xb3, 0xff, 0xff, 0xff, 0xb4, 0xff, 0xff, 0xff, 0xc7, 0xff,
                          0xff, 0xff, 0xbb, 0xff, 0xff, 0xff, 0xde, 0xff, 0xff, 0xff};
uint8_t SensorSlice3[] = {0x02, 0x63, 0xbc, 0xdf, 0x00, 0x00, 0xd8, 0xff, 0xff, 0xff, 0xd7, 0xff, 0xff, 0xff, 0xd9,
                          0xff, 0xff, 0xff, 0x9c, 0xff, 0xff, 0xff, 0x9a, 0xff, 0xff, 0xff, 0xa0, 0xff, 0xff, 0xff,
                          0xbe, 0xff, 0xff, 0xff, 0xcc, 0xff, 0xff, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xad, 0xff, 0xff,
                          0xff, 0xab, 0xff, 0xff, 0xff, 0xb7, 0xff, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xff, 0xac, 0xff,
                          0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xa7, 0xff, 0xff, 0xff,};

int32_t get_int_32(const uint8_t *array, size_t start_index) {
    int32_t value = 0;
    value |= array[start_index];
    value |= array[start_index + 1] << 8;
    value |= array[start_index + 2] << 16;
    value |= array[start_index + 3] << 24;
    return value;
}


uint32_t get_uint_32(const uint8_t *array, size_t start_index) {
    uint32_t value = 0;
    value |= array[start_index];
    value |= array[start_index + 1] << 8;
    value |= array[start_index + 2] << 16;
    value |= array[start_index + 3] << 24;
    return value;
}


sensor_data_t parse_sensor_data(const uint8_t *p_data) {
    sensor_data_t sensor_reading;
    sensor_reading.timestamp = get_uint_32(p_data, 2);
    // Read 16 bytes
    for (size_t i = 0; i < 16; i++) {
        size_t index = 6 + 4 * i; // 4 byte data from index 6
        sensor_reading.values[i] = get_int_32(p_data, index);
    }
    return sensor_reading;
}

char *reading_to_json(sensor_data_t *reading, char *json_obj) {
    snprintf(json_obj, 256, "{\"timestamp\":%u,\"readings\":[%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d]}",
             reading->timestamp, reading->values[0],
             reading->values[1],
             reading->values[2],
             reading->values[3],
             reading->values[4],
             reading->values[5],
             reading->values[6],
             reading->values[7],
             reading->values[8],
             reading->values[9],
             reading->values[10],
             reading->values[11],
             reading->values[12],
             reading->values[13],
             reading->values[14],
             reading->values[15]);
    return json_obj;
}

void print_sensor_reading(sensor_data_t *reading) {
    char json_obj[256];
    reading_to_json(reading, json_obj);
    printf("%s\n", json_obj);
}

int main() {
    printf("Parsing sensor reading...\n");
    sensor_data_t sensor_reading_1 = parse_sensor_data(SensorSlice2);
    print_sensor_reading(&sensor_reading_1);
    sensor_data_t sensor_reading_2 = parse_sensor_data(SensorSlice3);
    print_sensor_reading(&sensor_reading_2);
    return 0;
}